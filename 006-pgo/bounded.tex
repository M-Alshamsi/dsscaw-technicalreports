\chapter{CP-bounded team selection}
\label{chap:bounded}
Several Leagues (and some Research tasks) place a ceiling on the CP of
 participating Pokémon.
We have established that CP is a poor proxy for PvP performance, and thus
 expect that we might find strong candidates based on where CP fails.
If CP does not accurately represent a given Pokémon's chance to win, we ought
 be able to exploit this by assembling teams using undervalued Pokémon.
We first take the sorted list of Pokémon developed in \autoref{chap:unbounded},
 and remove all entries not in the optimal sets generated below.
We then select a team using the strategies of that chapter. Since
 that list was sorted according to a general strength function, it
 ought apply in this reduced context.
\textbf{This chapter has no relevance for Nx1 battles, nor the Master
  League, none of which employ CP bounds.}

\section{Optimal IVs and Levels under a CP bound}
For a given CP bound and Form, there is some optimal set of Pokémon Levels
 and Individual Vectors.
Higher IV components might require a lower level than lower components to
 come in under the same ceiling.
It is not possible to provide a global rule; optimal IVs are strongly
 dependent upon the base stats, and weakly dependent upon the opponent.
What can be said is that IVs add less value to a high base stat than a low
 base stat, and that higher levels provide diminishing returns.
For a base stat of 100, a corresponding IV component of 15 represents a
 15\% improvement to $Eff_A$.
For a base stat of 300, the same IV represents only a 5\% improvement.
A Level 10 Pokémon advancing to level 10.5 enjoys a 2.47\% improvement to
 $Eff_A$ (and also $Eff_D$ and $Eff_S$), paying a price of 5\% increase
 in CP.
Advancing from 30 to 30.5 represents only a 0.42\% improvement (and a
 0.83\% increase in CP).

The maximum level for which a 15--15--15 IV comes in under the bound is the
 minimum possible optimal level, since any lesser level would be strictly less
 powerful.
The maximum level for which a 0--0--0 IV comes in under the bound is the
 maximum possible optimal level, as it is not possible to gain another level
 while remaining within the bound.
Any IV with all three components less than or equal to another IV, but bounded
 by the same level, is strictly inferior to the second IV, and can be discarded.
Compute $Eff_A$, $Eff_D$, and $MHP$ using the IVs and corresponding levels.
Any resulting set with all three components less than or equal to some other set's
 is strictly inferior to the second, and can be discarded.
This captures $MHP$'s floor function.
What remains is an optimal frontier of at least one solution (usually
 many solutions), where arguments can be made for each depending on how one
 values attack, defense, and stamina, especially in the context of different
 opponents.

Before taking Power and Type into the question, let's examine the optimal
 solutions for a genus using the 1500 and 2500 CP bounds, using the
 geometric mean of $Eff_A$, $Eff_D$, and $MHP$ as our global fit function.
Timburr (134 ATK, 87 DEF, and 181 STA) evolves into
  Gurdurr (180 ATK, 134 DEF, and 198 STA), which evolves into
  Conkeldurr (243 ATK, 158 DEF, 233 STA).
Their base products are 2,110,098 (Timburr), 4,775,760 (Gurdurr),
  and 8,945,802 (Conkeldurr).
The geometric means are 128.263, 168.402, and 207.590.
Poor Timburr isn't really suited for the common PvP Leagues,
  and does best with a 15--15--15 at Level 50 (CP 1487).
Gurdurr can hold its own under a 1500 CP ceiling, and its
  optimal IVs are 1--15--15 at Level 26 (CP 1496).
It falls short of the Ultra League's 2500, though, where
  15--15--15 and 15--15--14 are functionally equivalent
  at Level 50 (both result in MHP of 178) despite
  respective CPs of 2452 and 2447.
It is impossible to distinguish between a Level 16.5 Conkeldurr at
  3--15--15 or 3--15--14 (134 MHP either way), though
  the CPs are 1500 and 1497.
In the Ultra League, Conkeldurr wants Level 28 0--15--12 with
  a CP of 2499.
Take two things away from this:
\begin{itemize}
\item The optimal IVs, and even the number of equivalent optimal IVs, can change across evolution.
  This is largely independent of any global fitness function.
\item Hitting the ceiling does not guarantee optimal IVs for most fitness functions.
  More generally, under most fitness functions, higher CP does not necessarily imply superior IVs.
    Gurdurr has numerous solutions yielding 1500 CP (Level 28 3--2--0, for instance, with geometric
    mean 120.015), but Level 26 1--15--15 beats it at 1496 (121.968).
\end{itemize}
There are many fitness functions. In the Gurdurr example given previously, 3--2--0 loses
    to 1--15--15 at geometric mean, but has an $Eff_A$ of 129.36, comfortably above the latter's 123.29.
 Does this compensate for six fewer hit points (145 vs 139) and lower $Eff_D$ (101.49 vs 96.136)?
 Let's pit them against one another, using Low Kick (Power of 4, neutral type effectiveness, STAB bonus).
 Our Level 28 competitor strikes for six damage with each attack:
    \[ \lfloor \frac{129.36 \times 4 \times 1.2}{101.49} \rfloor = \lfloor 6.118 \rfloor = 6 \]
 The supposedly optimal Gurdurr strikes for six as well:
    \[ \lfloor \frac{123.29 \times 4 \times 1.2}{96.136} \rfloor = \lfloor 6.156 \rfloor = 6 \]
 At 145 HP, Gurdurr goes down on the 25th attack.
 Its opponent's 139 HP absorbs 23 attacks before falling to the 24th, but this could
    have easily gone the other way.
 If the attack's Power were 10, both hit for nine damage, and both fall after nine attacks.

\section{Optimal League forms}
Pokémon GO offers two CP-bounded PvP leagues, the Great League (CP 1500) and
   the Ultra League (CP 2500).
\autoref{table:cp1500} lists all species' optimal level and IVs for the Great League\footnote{Forms
  disallowed in League play, particularly Mega, are not listed},
  as evaluated using the harmonic mean of $Eff_A$, $Eff_D$, and $MHP$.
It is possible for multiple sets of IVs to score equally due to the discrete nature
  of $MHP$, and in this case all optimal sets are listed (there are never more than
  two).
A few observations from this table:
In general, there is no correlation between $\sqrt{3}{BP}$ and level,
  save that everything at the bottom of the list is maxed (15/15/15@50),
  since many species cannot reach 1500 CP at all.
The geometric mean ($\sqrt{3}{BP}$) ranges from 51.39 (max Shedinja)
  to 147.18 (15/15/15@49.5 Chansey).
There is a strong bimodal preference for IVs: 15-15-15 for level 49.5
  and 50, and otherwise $n$-15-15 where $n < 2$, and $n$ usually equals 0.
This verifies that attack is highly overvalued in the CP calculation
  relative to $\sqrt{3}{BP}$ (not that we had any doubt).
Other IVs usually correspond to low level, powerful species, where a level
  raises CP by a large amount, leaving more room for beneficial IVs.
$Eff_A$ ranges from 63.02 (Chansey) to tremendous outlier 254.05 (Deoxys Attack).
In general, the top positions have relatively low $Eff_A$, rising in an
  orderly fashion to about 145 as we go down the list.
At this point, they become more disordered, until falling at the back
  of the list.
$MHP$ and $Eff_D$ are much less predictable.

\autoref{table:cp2500} does the same for the Ultra League, leaving out those species which
  can't hit a $\sqrt{3}{BP}$ of 115.
\textbf{FIXME: add plots of $Eff_A$, $Eff_D$, $MHP$ by geometric mean for optimal sets}
\input{out/bounded}

\section{Anticipating opponents}
Similarly to an unbounded contest, we can assume that a rational opponent is selecting
  according to the same rules as we are (or better), but a more powerful result is
  strong against all possible opponents.
